<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .app-screen, .app-view { display: none; }
        .active { display: block; }
        .active-flex { display: flex; }
        .modal-overlay { display: none; }
        .modal-overlay.active { display: flex; }
        .chart-container { position: relative; height: 40vh; width: 100%; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Telas de Login e Signup -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 active">
        <div class="w-full max-w-md bg-white shadow-lg rounded-xl p-8"><h2 class="text-3xl font-bold text-center text-indigo-600 mb-2">Feedback Hub</h2><p class="text-center text-gray-500 mb-8">Bem-vindo(a) de volta!</p><form id="login-form"><div class="mb-4"><label for="login-email" class="block text-sm font-medium mb-2">Email</label><input type="email" id="login-email" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required></div><div class="mb-6"><label for="login-password" class="block text-sm font-medium mb-2">Senha</label><input type="password" id="login-password" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg">Entrar</button></form><p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p><p class="text-center text-sm text-gray-500 mt-6">Não tem uma conta? <a href="#" id="go-to-signup" class="font-medium text-indigo-600">Cadastre-se</a></p></div>
    </div>
    <div id="signup-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white shadow-lg rounded-xl p-8"><h2 class="text-3xl font-bold text-center text-indigo-600 mb-2">Crie sua Conta</h2><p class="text-center text-gray-500 mb-8">Comece a dar e receber feedbacks.</p><form id="signup-form"><div class="grid grid-cols-1 gap-4"><input type="text" name="name" placeholder="Nome Completo" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required><input type="email" name="email" placeholder="Email Corporativo" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required><input type="password" name="password" placeholder="Senha" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$" title="Mínimo 8 caracteres, com maiúscula, minúscula, número e caractere especial." required><input type="password" name="confirmPassword" placeholder="Confirmar Senha" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required><select name="department" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required><option value="">Selecione o Setor</option><option value="Tecnologia">Tecnologia</option><option value="RH">Recursos Humanos</option><option value="Marketing">Marketing</option><option value="Vendas">Vendas</option></select><select name="role" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required><option value="">Selecione o Cargo</option><option value="usuario">Usuário</option><option value="gestor">Gestor</option><option value="admin">Administrador</option></select></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 mt-6 rounded-lg">Cadastrar</button></form><p id="signup-error" class="text-red-500 text-sm mt-4 text-center"></p><p class="text-center text-sm text-gray-500 mt-6">Já tem uma conta? <a href="#" id="go-to-login" class="font-medium text-indigo-600">Faça Login</a></p></div>
    </div>

    <!-- ===== Main App Screen ===== -->
    <div id="app-screen" class="min-h-screen lg:flex">
        <aside class="w-full lg:w-64 bg-white p-6 lg:h-screen lg:sticky lg:top-0 flex flex-col"><h1 class="text-2xl font-bold text-indigo-600 mb-8">Feedback Hub</h1><nav id="main-nav" class="space-y-2"></nav><div class="mt-auto pt-8"><button id="logout-button" class="w-full flex items-center justify-center gap-2 text-red-500 font-medium py-2 px-4 rounded-lg hover:bg-red-100"><i data-lucide="log-out" class="w-5 h-5"></i>Sair</button></div></aside>
        <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
            <div id="dashboard-view" class="app-view"><h2 class="text-3xl font-bold mb-6">Dashboard</h2><div class="chart-container"><canvas id="feedbackChart"></canvas></div></div>
            <div id="team-view" class="app-view"><h2 class="text-3xl font-bold mb-6">Minha Equipe</h2><div id="team-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div></div>
            <div id="send-feedback-view" class="app-view"><h2 class="text-3xl font-bold mb-6">Enviar Feedback</h2><div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-8"><form id="feedback-form"><div class="mb-4"><label class="block text-sm font-medium mb-2">Classificação</label><div class="flex gap-4"><label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer"><input type="radio" name="classification" value="ruim" class="form-radio text-red-500"> Ruim</label><label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer"><input type="radio" name="classification" value="media" class="form-radio text-yellow-500"> Média</label><label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer"><input type="radio" name="classification" value="boa" class="form-radio text-green-500" checked> Boa</label></div></div><div class="mb-4"><label for="feedback-recipient" class="block text-sm font-medium mb-2">Para quem?</label><select id="feedback-recipient" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required></select></div><div class="mb-4"><label for="feedback-title" class="block text-sm font-medium mb-2">Título</label><input type="text" id="feedback-title" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required></div><div class="mb-6"><label for="feedback-description" class="block text-sm font-medium mb-2">Descrição</label><textarea id="feedback-description" rows="5" class="w-full px-4 py-2 bg-gray-100 border rounded-lg" required></textarea></div><div class="mb-6 flex items-center"><input type="checkbox" id="feedback-anonymous" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="feedback-anonymous" class="ml-2 block text-sm text-gray-900">Enviar como anônimo</label></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg">Enviar Feedback</button></form><p id="feedback-success" class="text-green-500 text-sm mt-4 text-center"></p></div></div>
            <div id="reports-view" class="app-view"><div class="flex items-center justify-between mb-6"><h2 class="text-3xl font-bold">Relatórios</h2></div><div class="overflow-x-auto bg-white rounded-lg shadow-md"><table class="w-full text-left"><thead class="border-b"><tr><th class="p-4">Data</th><th class="p-4">De</th><th class="p-4">Para</th><th class="p-4">Título</th><th class="p-4">Classificação</th></tr></thead><tbody id="reports-table-body"></tbody></table></div></div>
            <div id="profile-view" class="app-view"><h2 class="text-3xl font-bold mb-6">Meu Perfil</h2><div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-8"><div class="flex items-center space-x-6 mb-8"><img id="profile-pic" src="https://placehold.co/128x128" alt="Foto do Perfil" class="w-24 h-24 rounded-full object-cover"><div class="flex-1"><h3 id="profile-name-display" class="text-2xl font-bold"></h3><p id="profile-role-display" class="text-gray-500 capitalize"></p><p id="profile-department-display" class="text-gray-500"></p></div></div><form id="profile-photo-form" class="mb-8 p-4 border rounded-lg"><label for="profile-photo-upload" class="block text-sm font-medium mb-2">Alterar Foto de Perfil</label><div class="flex items-center gap-4"><input type="file" id="profile-photo-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Enviar</button></div></form><form id="profile-details-form" class="p-4 border rounded-lg"><label for="profile-name" class="block text-sm font-medium">Nome</label><input type="text" id="profile-name" class="mt-1 mb-4 w-full px-4 py-2 bg-gray-100 border rounded-lg"><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg">Salvar Nome</button></form></div></div>
            <div id="admin-users-view" class="app-view"><h2 class="text-3xl font-bold mb-6">Gerenciar Usuários</h2><div class="overflow-x-auto bg-white rounded-lg shadow-md"><table class="w-full text-left"><thead class="border-b"><tr><th class="p-4">Nome</th><th class="p-4">Email</th><th class="p-4">Cargo</th><th class="p-4">Status</th><th class="p-4">Ações</th></tr></thead><tbody id="admin-users-table-body"></tbody></table></div></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="edit-user-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="text-xl font-bold mb-4">Editar Usuário</h3><form id="edit-user-form"><input type="hidden" id="edit-user-id"><div class="mb-4"><label for="edit-user-name">Nome</label><input type="text" id="edit-user-name" class="w-full mt-1 p-2 border rounded"></div><div class="mb-4"><label for="edit-user-email">Email</label><input type="email" id="edit-user-email" class="w-full mt-1 p-2 border rounded"></div><div class="mb-4"><label for="edit-user-department">Setor</label><select id="edit-user-department" class="w-full mt-1 p-2 border rounded"><option value="Tecnologia">Tecnologia</option><option value="RH">Recursos Humanos</option><option value="Marketing">Marketing</option><option value="Vendas">Vendas</option></select></div><div class="mb-4"><label for="edit-user-role">Cargo</label><select id="edit-user-role" class="w-full mt-1 p-2 border rounded"><option value="usuario">Usuário</option><option value="gestor">Gestor</option><option value="admin">Administrador</option></select></div><div class="mb-4 flex items-center"><input type="checkbox" id="edit-user-active" class="h-4 w-4 rounded"><label for="edit-user-active" class="ml-2">Ativo</label></div><div class="flex justify-end gap-4"><button type="button" id="cancel-edit-user" class="py-2 px-4 rounded">Cancelar</button><button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded">Salvar</button></div></form><hr class="my-6"><h4 class="font-bold mb-2">Redefinir Senha</h4><form id="reset-password-form"><div class="flex gap-2"><input type="password" id="reset-password-input" placeholder="Nova senha (mín. 8 caracteres)" class="flex-grow p-2 border rounded"><button type="submit" class="bg-yellow-500 text-white py-2 px-4 rounded">Redefinir</button></div></form></div></div>

    <script>
    // Estado global da aplicação
    const state = {
        currentUser: null,
        currentView: 'dashboard',
        feedbackChart: null,
        allUsers: [],
        API_URL: 'https://feedback-hub-backend.onrender.com/api/v1',
        screens: {},
        views: {},
        editUserModal: null,
        
        // Inicializa o estado
        init: function() {
            // Inicializa referências aos elementos
            this.screens = { 
                login: document.getElementById('login-screen'), 
                signup: document.getElementById('signup-screen'), 
                app: document.getElementById('app-screen') 
            };
            
            this.views = { 
                dashboard: document.getElementById('dashboard-view'), 
                team: document.getElementById('team-view'), 
                sendFeedback: document.getElementById('send-feedback-view'), 
                reports: document.getElementById('reports-view'), 
                profile: document.getElementById('profile-view'), 
                adminUsers: document.getElementById('admin-users-view') 
            };
            
            this.editUserModal = document.getElementById('edit-user-modal');
            
            // Inicializa os eventos
            this.initEvents();
            
            // Verifica a sessão do usuário
            this.checkSession();
        },
        
        // Inicializa os eventos
        initEvents: function() {
            // Eventos de navegação
            document.getElementById('go-to-signup')?.addEventListener('click', (e) => {
                e.preventDefault();
                this.showScreen('signup');
            });
            
            document.getElementById('go-to-login')?.addEventListener('click', (e) => {
                e.preventDefault();
                this.showScreen('login');
            });
            
            // Eventos de formulário
            document.getElementById('login-form')?.addEventListener('submit', (e) => this.handleLogin(e));
            document.getElementById('signup-form')?.addEventListener('submit', (e) => this.handleSignup(e));
            document.getElementById('logout-button')?.addEventListener('click', () => this.handleLogout());
            
            // Outros eventos
            document.getElementById('cancel-edit-user')?.addEventListener('click', () => {
                this.editUserModal?.classList.remove('active');
            });
        },
        
        // Mostra uma tela específica
        showScreen: function(screenName) {
            console.log('Mostrando tela:', screenName);
            
            // Esconde todas as telas
            Object.values(this.screens).forEach(screen => {
                if (screen) screen.classList.remove('active');
            });
            
            // Mostra a tela solicitada
            const screen = this.screens[screenName] || document.getElementById(`${screenName}-screen`);
            if (screen) {
                screen.classList.add('active');
                console.log('Tela ativada:', screen.id);
                
                // Se for a tela do app, garante que a view correta seja mostrada
                if (screenName === 'app') {
                    console.log('Inicializando app...');
                    this.initializeApp();
                }
            } else {
                console.error('Tela não encontrada:', screenName);
                // Se não encontrar a tela, mostra a tela de login por padrão
                if (this.screens.login) {
                    this.screens.login.classList.add('active');
                }
            }
        },
        
        // Mostra uma view específica dentro do app
        showView: function(viewName) {
            console.log('Mostrando view:', viewName);
            
            // Atualiza a view ativa
            this.currentView = viewName;
            
            // Esconde todas as views
            Object.values(this.views).forEach(view => {
                if (view) view.style.display = 'none';
            });
            
            // Mostra a view solicitada
            const view = this.views[viewName] || document.getElementById(`${viewName}-view`);
            if (view) {
                view.style.display = 'block';
                console.log('View ativada:', view.id);
            } else {
                console.error('View não encontrada:', viewName);
                // Se não encontrar a view, mostra o dashboard por padrão
                if (this.views.dashboard) {
                    this.views.dashboard.style.display = 'block';
                    this.currentView = 'dashboard';
                }
            }
            
            // Atualiza destaque do menu
            this.updateNavHighlight();
        },
        
        // Atualiza o destaque do menu de navegação
        updateNavHighlight: function() {
            const navItems = document.querySelectorAll('#main-nav a');
            navItems.forEach(item => {
                item.classList.remove('bg-gray-100', 'text-indigo-600');
                if (item.dataset.view === this.currentView) {
                    item.classList.add('bg-gray-100', 'text-indigo-600');
                }
            });
        },
        
        // Verifica se o usuário está autenticado
        checkSession: function() {
            console.log('Verificando sessão...');
            const token = localStorage.getItem('feedbackHubToken');
            
            if (token) {
                // Simula uma verificação de token
                // Em produção, você faria uma chamada para a API
                console.log('Token encontrado, verificando...');
                
                // Simulação de usuário logado para testes
                this.currentUser = {
                    id: 1,
                    name: 'Usuário Teste',
                    email: 'teste@exemplo.com',
                    role: 'usuario'
                };
                
                this.initializeApp();
            } else {
                console.log('Nenhum token encontrado, redirecionando para login...');
                this.showScreen('login');
            }
        },
        
        // Inicializa o aplicativo
        initializeApp: function() {
            console.log('Inicializando aplicativo...');
            
            // Mostra a tela do aplicativo
            this.showScreen('app');
            
            // Mostra a view inicial (dashboard)
            this.showView('dashboard');
            
            // Renderiza o menu de navegação
            this.renderNav();
            
            // Atualiza o nome do usuário na interface
            const userNameElement = document.getElementById('user-name');
            if (userNameElement && this.currentUser) {
                userNameElement.textContent = this.currentUser.name;
            }
        },
        
        // Renderiza o menu de navegação
        renderNav: function() {
            const navElement = document.getElementById('main-nav');
            if (!navElement) return;
            
            let navItems = '';
            
            // Itens do menu baseados nas permissões do usuário
            navItems += `
                <a href="#" data-view="dashboard" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                <a href="#" data-view="sendFeedback" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                    <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>
                    Enviar Feedback
                </a>
            `;
            
            // Itens adicionais para administradores
            if (this.currentUser?.role === 'admin') {
                navItems += `
                    <a href="#" data-view="adminUsers" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                        Gerenciar Usuários
                    </a>
                `;
            }
            
            // Link para o perfil
            navItems += `
                <a href="#" data-view="profile" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i>
                    Meu Perfil
                </a>
            `;
            
            navElement.innerHTML = navItems;
            
            // Adiciona os eventos de clique aos itens do menu
            navElement.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = link.dataset.view;
                    if (view) {
                        this.showView(view);
                    }
                });
            });
            
            // Atualiza os ícones do Lucide
            lucide.createIcons();
        },
        
        // Manipula o login do usuário
        handleLogin: async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email')?.value;
            const password = document.getElementById('login-password')?.value;
            const errorElement = document.getElementById('login-error');
            
            if (!email || !password) {
                if (errorElement) errorElement.textContent = 'Por favor, preencha todos os campos.';
                return;
            }
            
            try {
                // Simulação de login bem-sucedido
                console.log('Tentando fazer login com:', email);
                
                // Em produção, você faria uma chamada para a API:
                // const response = await this.apiRequest('/auth/login', 'POST', { email, password });
                // this.currentUser = response.user;
                // localStorage.setItem('feedbackHubToken', response.token);
                
                // Simulação de resposta da API
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                this.currentUser = {
                    id: 1,
                    name: 'Usuário Teste',
                    email: email,
                    role: 'usuario'
                };
                
                // Salva o token de autenticação (simulado)
                localStorage.setItem('feedbackHubToken', 'simulated-token');
                
                // Inicializa o aplicativo
                this.initializeApp();
                
            } catch (error) {
                console.error('Erro no login:', error);
                if (errorElement) {
                    errorElement.textContent = error.message || 'Erro ao fazer login. Tente novamente.';
                }
            }
        },
        
        // Manipula o cadastro de novo usuário
        handleSignup: async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const errorElement = document.getElementById('signup-error');
            
            if (!data.name || !data.email || !data.password || !data.confirmPassword) {
                if (errorElement) errorElement.textContent = 'Por favor, preencha todos os campos.';
                return;
            }
            
            if (data.password !== data.confirmPassword) {
                if (errorElement) errorElement.textContent = 'As senhas não coincidem.';
                return;
            }
            
            try {
                console.log('Tentando cadastrar usuário:', data.email);
                
                // Em produção, você faria uma chamada para a API:
                // const response = await this.apiRequest('/auth/register', 'POST', data);
                
                // Simulação de resposta da API
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Limpa o formulário
                e.target.reset();
                
                // Mostra mensagem de sucesso e redireciona para o login
                alert('Cadastro realizado com sucesso! Faça login para continuar.');
                this.showScreen('login');
                
            } catch (error) {
                console.error('Erro no cadastro:', error);
                if (errorElement) {
                    errorElement.textContent = error.message || 'Erro ao cadastrar. Tente novamente.';
                }
            }
        },
        
        // Manipula o logout do usuário
        handleLogout: function() {
            console.log('Efetuando logout...');
            
            // Remove o token de autenticação
            localStorage.removeItem('feedbackHubToken');
            
            // Limpa o estado do usuário
            this.currentUser = null;
            
            // Redireciona para a tela de login
            this.showScreen('login');
        }
    };
    
    // Inicializa a aplicação quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializa o estado da aplicação
        state.init();
        
        // Inicializa os ícones do Lucide
        lucide.createIcons();
    });

        // Função auxiliar para fazer requisições à API
        const apiRequest = async (endpoint, method = 'GET', body = null) => {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            const token = localStorage.getItem('feedbackHubToken');
            if (token) headers['Authorization'] = `Bearer ${token}`;
            
            const config = { 
                method, 
                headers,
                mode: 'cors',
                cache: 'no-cache'
            };
            
            if (body) {
                if (body instanceof FormData) {
                    // Para FormData, não definir Content-Type, o navegador irá definir com o boundary correto
                    delete headers['Content-Type'];
                    config.body = body;
                } else {
                    config.body = JSON.stringify(body);
                }
            }
            
            try {
                console.log(`[${method}] ${state.API_URL}${endpoint}`, { body: config.body });
                
                const response = await fetch(`${state.API_URL}${endpoint}`, config);
                
                if (response.status === 401 || response.status === 403) {
                    state.handleLogout();
                    throw new Error("Sessão expirada. Faça login novamente.");
                }
                
                const data = await response.json().catch(() => ({}));
                
                if (!response.ok) {
                    throw new Error(data.message || `Erro na requisição: ${response.statusText}`);
                }
                
                return data;
                
            } catch (error) {
                console.error('Erro na requisição:', error);
                throw error;
            }
        };
        
        // Função para mostrar/esconder telas
        function showScreen(screenName) {
            console.log('Mostrando tela:', screenName);
            
            // Esconde todas as telas
            Object.values(state.screens).forEach(screen => {
                if (screen) screen.classList.remove('active');
            });
            
            // Mostra a tela solicitada
            const screen = state.screens[screenName] || document.getElementById(`${screenName}-screen`);
            if (screen) {
                screen.classList.add('active');
                console.log('Tela ativada:', screen.id);
                
                // Se for a tela do app, garante que a view correta seja mostrada
                if (screenName === 'app') {
                    console.log('Inicializando app...');
                    state.initializeApp();
                }
            } else {
                console.error('Tela não encontrada:', screenName);
                // Se não encontrar a tela, mostra a tela de login por padrão
                if (state.screens.login) {
                    state.screens.login.classList.add('active');
                }
            }
        }
        
        // Função para mostrar/esconder views dentro do app
        function showView(viewName) {
            console.log('Mostrando view:', viewName);
            
            // Atualiza a view ativa
            state.currentView = viewName;
            
            // Esconde todas as views
            Object.values(state.views).forEach(view => {
                if (view) view.style.display = 'none';
            });
            
            // Mostra a view solicitada
            const view = state.views[viewName] || document.getElementById(`${viewName}-view`);
            if (view) {
                view.style.display = 'block';
                console.log('View ativada:', view.id);
            } else {
                console.error('View não encontrada:', viewName);
                // Se não encontrar a view, mostra o dashboard por padrão
                if (state.views.dashboard) {
                    state.views.dashboard.style.display = 'block';
                    state.currentView = 'dashboard';
                }
            }
            
            // Atualiza destaque do menu
            updateNavHighlight();
        }
        
        // Função para atualizar destaque do menu
        function updateNavHighlight() {
            const navItems = document.querySelectorAll('#main-nav a');
            navItems.forEach(item => {
                item.classList.remove('bg-gray-100', 'text-indigo-600');
                if (item.dataset.view === state.activeView) {
                    item.classList.add('bg-gray-100', 'text-indigo-600');
                }
            });
        }
        
        const handleLogin = async e => { 
            e.preventDefault(); 
            try { 
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                // Simulação de login bem-sucedido
                // Em produção, substitua por uma chamada real à API
                state.currentUser = { 
                    name: 'Usuário Teste',
                    email: email,
                    role: 'usuario',
                    id: 1
                };
                
                // Salva o token de autenticação (simulado)
                localStorage.setItem('feedbackHubToken', 'simulated-token');
                
                // Mostra a tela do app
                initializeApp();
                
            } catch(err) { 
                const errorEl = document.getElementById('login-error');
                if (errorEl) {
                    errorEl.textContent = err.message || 'Erro ao fazer login. Tente novamente.';
                }
            }
        };
        
        const handleSignup = async (e) => { 
            e.preventDefault(); 
            const formData = new FormData(e.target); 
            const data = Object.fromEntries(formData.entries()); 
            const errorEl = document.getElementById('signup-error'); 
            errorEl.textContent = ''; 
            
            if (data.password !== data.confirmPassword) { 
                errorEl.textContent = 'As senhas não coincidem.'; 
                return; 
            } 
            
            try { 
                // Simulação de cadastro bem-sucedido
                // Em produção, substitua por uma chamada real à API
                await new Promise(resolve => setTimeout(resolve, 1000));
                alert('Cadastro realizado com sucesso! Faça login para continuar.'); 
                showScreen('login'); 
                e.target.reset(); 
            } catch (error) { 
                errorEl.textContent = error.message; 
            }
        };
        
        const handleLogout = () => { 
            localStorage.removeItem('feedbackHubToken'); 
            state.currentUser = null; 
            showScreen('login'); 
        };

        const checkSession = async () => { 
            // Verifica se há um token de autenticação
            if (localStorage.getItem('feedbackHubToken')) {
                try {
                    // Em produção, faça uma chamada para validar o token
                    // state.currentUser = await apiRequest('/profile');
                    
                    // Simulação de usuário logado
                    state.currentUser = {
                        id: 1,
                        name: 'Usuário Teste',
                        email: 'teste@exemplo.com',
                        role: 'usuario'
                    };
                    
                    initializeApp(); 
                } catch (error) { 
                    console.error('Erro na sessão:', error);
                    handleLogout(); 
                } 
            } else {
                // Se não houver token, mostra a tela de login
                showScreen('login');
            }
        };

        const initializeApp = () => { 
            // Renderiza o menu de navegação
            renderNav(); 
            
            // Mostra a tela do app
            showScreen('app'); 
            
            // Mostra a view inicial (dashboard)
            showView('dashboard'); 
            
            // Atualiza o nome do usuário na interface
            const userNameElement = document.getElementById('user-name');
            if (userNameElement && state.currentUser) {
                userNameElement.textContent = state.currentUser.name;
            }
        };

        const renderNav = () => {
            let navItems = `<a href="#" data-view="dashboard" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100"><i data-lucide="layout-dashboard"></i> Dashboard</a>`;
            if (state.currentUser.role !== 'usuario') navItems += `<a href="#" data-view="team" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100"><i data-lucide="users"></i> Minha Equipe</a>`;
            navItems += `<a href="#" data-view="sendFeedback" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100"><i data-lucide="send"></i> Enviar Feedback</a>`;
            if (state.currentUser.role !== 'usuario') navItems += `<a href="#" data-view="reports" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100"><i data-lucide="bar-chart-3"></i> Relatórios</a>`;
            if (state.currentUser.role === 'admin') navItems += `<a href="#" data-view="adminUsers" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100"><i data-lucide="shield"></i> Gerenciar Usuários</a>`;
            navItems += `<a href="#" data-view="profile" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100"><i data-lucide="user-circle"></i> Perfil</a>`;
            document.getElementById('main-nav').innerHTML = navItems;
            lucide.createIcons();
            document.getElementById('main-nav').querySelectorAll('a').forEach(a => a.onclick = (e) => { e.preventDefault(); showView(a.dataset.view); });
        };
        
        const renderActiveView = () => { const renderMap = { dashboard: renderDashboard, team: renderTeam, sendFeedback: renderSendFeedback, reports: renderReports, profile: renderProfile, adminUsers: renderAdminUsers }; if (renderMap[state.currentView]) renderMap[state.currentView](); };
        const renderDashboard = async () => { try { const feedbacks = await apiRequest('/feedbacks'); const counts = { boa: 0, media: 0, ruim: 0 }; feedbacks.forEach(f => counts[f.classification]++); const ctx = document.getElementById('feedbackChart').getContext('2d'); if (state.feedbackChart) state.feedbackChart.destroy(); state.feedbackChart = new Chart(ctx, { type: 'bar', data: { labels: ['Bons', 'Médios', 'Ruins'], datasets: [{ data: [counts.boa, counts.media, counts.ruim], backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: false } } } }); } catch (error) { console.error(error); }};
        const renderTeam = async () => { try { const team = await apiRequest('/team'); document.getElementById('team-list').innerHTML = team.map(m => `<div class="bg-white rounded-lg shadow p-4 text-center"><img src="${m.photoUrl}" class="w-20 h-20 rounded-full mx-auto mb-2 object-cover"><h4 class="font-semibold">${m.name}</h4><p class="text-sm text-gray-500 capitalize">${m.role}</p></div>`).join(''); } catch(e) { console.error(e); } };
        const renderReports = async () => { try { const feedbacks = await apiRequest('/feedbacks'); const classificationMap = { boa: 'Boa', media: 'Média', ruim: 'Ruim' }; document.getElementById('reports-table-body').innerHTML = feedbacks.map(f => `<tr class="border-b"><td class="p-4">${new Date(f.date).toLocaleDateString()}</td><td class="p-4">${f.fromUserName}</td><td class="p-4">${f.toUserName}</td><td class="p-4">${f.title}</td><td class="p-4">${classificationMap[f.classification]}</td></tr>`).join(''); } catch(e) { console.error(e); } };
        const renderSendFeedback = async () => { try { const users = await apiRequest('/users'); document.getElementById('feedback-recipient').innerHTML = users.map(u => `<option value="${u.id}">${u.name}</option>`).join(''); document.getElementById('feedback-form').reset(); document.getElementById('feedback-success').textContent = ''; } catch(e) { console.error(e); } };
        const renderProfile = () => { const user = state.currentUser; document.getElementById('profile-pic').src = user.photoUrl || 'https://placehold.co/128x128'; document.getElementById('profile-name-display').textContent = user.name; document.getElementById('profile-role-display').textContent = user.role; document.getElementById('profile-department-display').textContent = user.department; document.getElementById('profile-name').value = user.name; };
        
        const renderAdminUsers = async () => {
            try {
                state.allUsers = await apiRequest('/admin/users');
                document.getElementById('admin-users-table-body').innerHTML = state.allUsers.map(u => `
                    <tr class="border-b"><td class="p-4 flex items-center gap-2"><img src="${u.photoUrl || 'https://placehold.co/40x40'}" class="w-8 h-8 rounded-full object-cover"> ${u.name}</td><td class="p-4">${u.email}</td><td class="p-4 capitalize">${u.role}</td><td class="p-4">${u.isActive ? '<span class="text-green-600 font-semibold">Ativo</span>' : '<span class="text-red-600 font-semibold">Inativo</span>'}</td><td class="p-4"><button data-userid="${u.id}" class="edit-user-btn bg-blue-500 text-white py-1 px-3 rounded">Editar</button> <button data-userid="${u.id}" class="delete-user-btn bg-red-500 text-white py-1 px-3 rounded ml-2">Excluir</button></td></tr>`).join('');
            } catch(e) { console.error(e); }
        };

        const openEditModal = (userId) => { const user = state.allUsers.find(u => u.id === userId); if (!user) return; document.getElementById('edit-user-id').value = user.id; document.getElementById('edit-user-name').value = user.name; document.getElementById('edit-user-email').value = user.email; document.getElementById('edit-user-department').value = user.department; document.getElementById('edit-user-role').value = user.role; document.getElementById('edit-user-active').checked = user.isActive; editUserModal.classList.add('active'); };

        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM carregado, inicializando...');
            
            // Inicializa o estado da aplicação
            state.init();
            
            // Inicializa os ícones do Lucide
            lucide.createIcons();
            
            // Adiciona event listeners para navegação
            document.getElementById('go-to-signup')?.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Navegando para cadastro');
                state.showScreen('signup');
            });
            
            document.getElementById('go-to-login')?.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Navegando para login');
                state.showScreen('login');
            });
            
            // Adiciona event listeners para formulários
            document.getElementById('login-form')?.addEventListener('submit', (e) => state.handleLogin(e));
            document.getElementById('signup-form')?.addEventListener('submit', (e) => state.handleSignup(e));
            document.getElementById('logout-button')?.addEventListener('click', () => state.handleLogout());
            
            // Verifica a sessão do usuário
            state.checkSession();
            
            // Configura os itens do menu de navegação
            const navLinks = `
                <a href="#" data-view="dashboard" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                <a href="#" data-view="team" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                    <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                    Minha Equipe
                </a>
                <a href="#" data-view="send-feedback" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                    <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>
                    Enviar Feedback
                </a>
                <a href="#" data-view="reports" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                    Relatórios
                </a>
                <a href="#" data-view="profile" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100">
                    <i data-lucide="user" class="w-5 h-5 mr-3"></i>
                    Meu Perfil
                </a>
            `;
            
            const navElement = document.getElementById('main-nav');
            if (navElement) {
                navElement.innerHTML = navLinks;
                
                // Adiciona event listeners para os links de navegação
                navElement.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const view = link.dataset.view;
                        if (view) {
                            state.activeView = view;
                            showView(view);
                        }
                    });
                });
            }
            
            // Garante que pelo menos a tela de login esteja visível
            if (!document.querySelector('.app-screen.active')) {
                console.log('Nenhuma tela ativa, mostrando login...');
                state.showScreen('login');
            }
        });
    </script>
</body>
</html>

